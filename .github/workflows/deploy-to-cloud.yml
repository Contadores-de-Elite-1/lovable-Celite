name: Deploy to Supabase Cloud

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/seed.sql'
      - '.github/workflows/deploy-to-cloud.yml'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate before Deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Validate Migrations
        run: |
          echo "üîç Validating migrations before deployment..."

          MIGRATION_COUNT=$(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)
          echo "‚úÖ Found $MIGRATION_COUNT migrations"

          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              OPEN=$(grep -o "(" "$file" | wc -l)
              CLOSE=$(grep -o ")" "$file" | wc -l)
              if [ "$OPEN" -ne "$CLOSE" ]; then
                echo "‚ùå Syntax error in $file"
                exit 1
              fi
            fi
          done

          echo "‚úÖ All migrations valid"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    name: Deploy to Supabase Cloud

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Deploy Migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.CLAUDECODE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: zytxwdgzjqrcmbnpgofj
        run: |
          echo "üöÄ Deploying migrations to Supabase Cloud..."

          supabase migrations list --project-id $SUPABASE_PROJECT_ID || echo "Checking project..."

          supabase db push --project-id $SUPABASE_PROJECT_ID

          echo "‚úÖ Migrations deployed"

      - name: Deploy Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.CLAUDECODE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: zytxwdgzjqrcmbnpgofj
        run: |
          echo "üöÄ Deploying edge functions..."

          FUNCTIONS_DIR="supabase/functions"

          if [ -d "$FUNCTIONS_DIR" ]; then
            for func_dir in "$FUNCTIONS_DIR"/*/; do
              if [ -f "$func_dir/index.ts" ]; then
                FUNC_NAME=$(basename "$func_dir")
                echo "  Deploying: $FUNC_NAME"

                supabase functions deploy "$FUNC_NAME" \
                  --project-id $SUPABASE_PROJECT_ID \
                  --no-verify-jwt || echo "‚ö†Ô∏è  Function $FUNC_NAME might not need deployment"
              fi
            done
            echo "‚úÖ Functions deployed"
          else
            echo "‚ö†Ô∏è  No functions to deploy"
          fi

      - name: Verify Deployment
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.CLAUDECODE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: zytxwdgzjqrcmbnpgofj
        run: |
          echo "üîç Verifying deployment..."

          supabase status --project-id $SUPABASE_PROJECT_ID

          echo "‚úÖ Deployment complete!"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo ""
          echo "üìä Summary:"
          echo "  ‚Ä¢ Migrations applied to Cloud"
          echo "  ‚Ä¢ Functions deployed"
          echo "  ‚Ä¢ Everything is live! üöÄ"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå DEPLOYMENT FAILED"
          echo ""
          echo "üìã Check the logs above for details"
          echo "üí° Common issues:"
          echo "  ‚Ä¢ Invalid SQL syntax"
          echo "  ‚Ä¢ Missing function files"
          echo "  ‚Ä¢ Network connectivity"
