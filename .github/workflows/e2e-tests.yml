name: Celite E2E Tests - Automated Pipeline

on:
  push:
    branches:
      - claude/fix-database-types-and-rpc-*
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      full_debug:
        description: 'Enable full debugging output'
        required: false
        default: 'false'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    name: E2E Tests - Backend Validation

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Install Supabase CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/supabase/cli/main/install.sh | bash
          supabase --version

      - name: Start Supabase
        run: |
          echo "ğŸš€ Starting Supabase..."
          supabase start
          sleep 30
          echo "âœ… Supabase started"

      - name: Wait for Supabase API
        run: |
          echo "â³ Waiting for Supabase API to be ready..."
          for i in {1..60}; do
            if curl -s http://localhost:54321/rest/v1/ > /dev/null 2>&1; then
              echo "âœ… Supabase API is ready (attempt $i)"
              exit 0
            fi
            echo "  Attempt $i/60 - waiting..."
            sleep 2
          done
          echo "âŒ Timeout: Supabase API did not respond"
          echo ""
          echo "Debug info:"
          supabase status
          exit 1

      - name: Apply migrations
        run: |
          echo "ğŸ“¦ Applying migrations..."
          supabase db push
          echo "âœ… Migrations applied"

      - name: Load seed data
        run: |
          echo "ğŸŒ± Loading seed data..."
          STATUS=$(supabase status)
          DB_URL=$(echo "$STATUS" | grep "Database URL:" | awk '{print $NF}')
          if [ -z "$DB_URL" ]; then
            echo "âŒ Could not extract DB_URL from status"
            echo "Status output:"
            echo "$STATUS"
            exit 1
          fi
          psql "$DB_URL" -f supabase/scripts/seed.sql
          echo "âœ… Seed data loaded"

      - name: Run E2E tests
        id: e2e_tests
        run: |
          echo "ğŸ§ª Running E2E tests (11 validations)..."
          bash supabase/scripts/run-e2e-local.sh 2>&1 | tee /tmp/e2e-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: Check test results
        id: test_results
        run: |
          if [ -f "/tmp/e2e-results.txt" ]; then
            RESULT=$(cat /tmp/e2e-results.txt)
            echo "result=$RESULT" >> $GITHUB_OUTPUT
            if [ "$RESULT" = "PASSED" ]; then
              echo "âœ… ALL E2E TESTS PASSED"
            else
              echo "âŒ SOME E2E TESTS FAILED"
            fi
          else
            echo "âš ï¸  Results file not found"
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-logs
          path: |
            /tmp/e2e-output.log
            /tmp/e2e-results.txt
          retention-days: 7

      - name: Debug info on failure
        if: failure() || steps.e2e_tests.outcome == 'failure'
        run: |
          echo "ğŸ” Collecting debug information..."
          echo ""
          echo "=== Supabase Status ==="
          supabase status || true
          echo ""
          echo "=== Database Info ==="
          STATUS=$(supabase status)
          DB_URL=$(echo "$STATUS" | grep "Database URL:" | awk '{print $NF}')
          if [ -n "$DB_URL" ]; then
            echo "Database: $DB_URL"
            psql "$DB_URL" -c "\dt" || true
          fi
          echo ""
          echo "=== Supabase Logs ==="
          if [ -d ".supabase/logs" ]; then
            ls -la .supabase/logs/ || true
          fi
          echo ""
          echo "=== E2E Output ==="
          if [ -f "/tmp/e2e-output.log" ]; then
            tail -100 /tmp/e2e-output.log
          fi

      - name: Create GitHub Actions summary
        if: always()
        run: |
          {
            echo "# âœ… Celite E2E Test Report"
            echo ""
            echo "## Test Execution"
            if [ -f "/tmp/e2e-results.txt" ]; then
              RESULT=$(cat /tmp/e2e-results.txt)
              if [ "$RESULT" = "PASSED" ]; then
                echo "### âœ… STATUS: ALL TESTS PASSED"
              else
                echo "### âŒ STATUS: TESTS FAILED"
              fi
            else
              echo "### âš ï¸  STATUS: UNKNOWN (results file not found)"
            fi
            echo ""
            echo "## Validations Run"
            echo "- âœ… Supabase API availability"
            echo "- âœ… Credential extraction"
            echo "- âœ… Database migration (13 migrations)"
            echo "- âœ… Test data seed"
            echo "- âœ… ASAAS webhook simulation"
            echo "- âœ… Commission calculation"
            echo "- âœ… Commission approval batch"
            echo "- âœ… Payment processing"
            echo "- âœ… RLS policy isolation"
            echo "- âœ… Audit logging"
            echo ""
            echo "## Artifacts"
            echo "- Full logs: [e2e-test-logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "## Next Steps"
            if [ "$(cat /tmp/e2e-results.txt 2>/dev/null)" = "PASSED" ]; then
              echo "âœ… Backend validation complete. Ready for Week 2 (Frontend development)"
            else
              echo "âŒ Debugging required. Check logs and artifacts above."
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Fail if tests failed
        if: steps.test_results.outputs.result != 'PASSED'
        run: |
          echo "âŒ E2E tests did not pass"
          exit 1

      - name: Success summary
        if: success()
        run: |
          echo "ğŸ‰ BACKEND VALIDATION COMPLETE!"
          echo "âœ… All 11 E2E tests passed"
          echo "âœ… System ready for next phase"
