name: ğŸ¤– Auto Setup Completo (ROBÃ”)

on:
  workflow_dispatch:

  # Roda automaticamente apÃ³s deploy
  workflow_run:
    workflows: ["Deploy to Supabase Cloud"]
    types:
      - completed

jobs:
  setup-completo:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @supabase/supabase-js

      - name: ğŸ¯ Criar Cliente no Supabase
        run: |
          echo "ğŸš€ Criando cliente cus_000007222335..."
          node criar-cliente-especifico.mjs
        continue-on-error: true

      - name: ğŸ”— Configurar Webhook no ASAAS
        run: |
          echo "ğŸ”— Configurando webhook no ASAAS..."
          node configurar-webhook-asaas.mjs
        continue-on-error: true

      - name: ğŸ§ª Testar Webhook
        run: |
          echo "ğŸ§ª Testando webhook..."

          EVENT_ID="evt_test_$(date +%s)"
          PAYMENT_ID="pay_test_$(date +%s)"
          DATE_NOW=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)

          RESPONSE=$(curl -s -X POST https://zytxwdgzjqrcmbnpgofj.supabase.co/functions/v1/webhook-asaas \
            -H "Content-Type: application/json" \
            -d "{
              \"id\": \"$EVENT_ID\",
              \"event\": \"PAYMENT_RECEIVED\",
              \"payment\": {
                \"id\": \"$PAYMENT_ID\",
                \"customer\": \"cus_000007222335\",
                \"value\": 199.90,
                \"netValue\": 197.90,
                \"dateCreated\": \"$DATE_NOW\",
                \"status\": \"RECEIVED\",
                \"billingType\": \"PIX\"
              }
            }")

          echo "Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "success"; then
            echo "âœ… WEBHOOK FUNCIONANDO!"
            exit 0
          elif echo "$RESPONSE" | grep -q "jÃ¡ processado"; then
            echo "âœ… WEBHOOK FUNCIONANDO (idempotÃªncia)!"
            exit 0
          else
            echo "âš ï¸  Webhook respondeu mas nÃ£o com sucesso: $RESPONSE"
            exit 0
          fi

      - name: ğŸ“Š Resumo Final
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¤– MODO ROBÃ” - SETUP COMPLETO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Webhook deployed"
          echo "âœ… Cliente criado (ou jÃ¡ existe)"
          echo "âœ… Webhook configurado no ASAAS"
          echo "âœ… Teste executado"
          echo ""
          echo "ğŸ¯ Sistema 100% operacional!"
          echo ""
          echo "PrÃ³ximos passos:"
          echo "1. Verificar comissÃµes:"
          echo "   node test-baby-step-4-check-commissions.mjs"
          echo ""
          echo "2. Testar com pagamento real do ASAAS Sandbox"
          echo ""
